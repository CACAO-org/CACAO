<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cacao: cacao Hardware Simulation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cacao-logo-small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cacao
   &#160;<span id="projectnumber">Alpha Release 0.1.0</span>
   </div>
   <div id="projectbrief">Compute And Control For Adaptive Optics</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_cacao_Hardware_Simulation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">cacao Hardware Simulation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p>There are 3 methods for users to simulate hardware</p>
<ul>
<li>METHOD 1: Provide an external simulation that adheres to AOloopControl input/output conventions</li>
<li>METHOD 2: Use the physical hardware simulation provided by the package</li>
<li>METHOD 3: Use the linear hardware simulation: this option is fastest, but only captures linear relationships between DM actuators and WFS signals</li>
</ul>
<h2>METHOD 1: Provide an external simulation that adheres to AOloopControl input/output conventions</h2>
<p>The user runs a loop that updates the wavefront sensor image when the DM input changes. Both the DM and WFS are represented as shared memory image streams. When a new DM shape is written, the DM stream semaphores are posted by the user, triggering the WFS image computation. When the WFS image is computed, its semaphores are posted.</p>
<h2>METHOD 2: Physical hardware simulation</h2>
<p>The AOsim simulation architecture relies on individual processes that simulate subsystems. Each process is launched by a bash script. ASCII configuration files are read by each process. Data I/O can be done with low latency using shared memory and semaphores: a process operation (for example, the wavefront sensor process computing WFS signals) is typically triggered by a semaphore contained in the shared memory wavefront stream. A low-speed file system based alternative to shared memory and semaphores is also provided.</p>
<p>Method 2 simulates incoming atmospheric WFs, a pyramid WFS based loop feeding a DM, a coronagraphic LOWFS and coronagraphic PSFs.</p>
<h3>Running Method 2</h3>
<p>Launch the simulator with the following steps:</p>
<ul>
<li><p class="startli">Create a series of atmospheric wavefronts (do this only once, this step can take several hrs): </p><pre class="fragment">  ./aohardsim/aosimmkwfser
</pre><p class="startli">Stop the process when a few wavefront files have been created (approximately 10 minimum). The AO code will loop through the list of files created, so a long list is preferable to reduce the frequency at which the end-of-sequence discontinuity occurs. The current wavefront file index is displayed as the process runs; in this example, the process is working on file #2: </p><pre class="fragment">Layer  0/ 7, Frame   99/ 100, File      0/100000000  [TIME =     0.0990 s]  WRITING SCIENCE WAVEFRONT ... - 
Layer  0/ 7, Frame   99/ 100, File      1/100000000  [TIME =     0.1990 s]  WRITING SCIENCE WAVEFRONT ... - 
Layer  1/ 7, Frame   42/ 100, File      2/100000000  [TIME =     0.2420 s]  
</pre><p class="startli">Type <code>CTRL-C</code> to stop the process. Note that you can relaunch the script later to build additional wavefront files.</p>
<p class="startli">By default, the wavefront files are stored in the work directory. You may choose to move them to another location (useful if you have multiple work directories sharing the same wavefront files). You can then create a symbolic link <code>atmwf</code> to an existing atmospheric wavefront simulation directory. For example: </p><pre class="fragment">ln -s /data/AtmWF/wdir00/ atmwf
</pre></li>
<li>Execute master script <code>./aohardsim/runAOhsim</code></li>
<li>To stop the physical simulator: <code>./aohardsim/runAOhsim -k</code></li>
</ul>
<p>Important notes:</p>
<ul>
<li>Parameters for the simulation can be changed by editing the <code>.conf</code> files in the <code>aohardsim</code> directory</li>
<li>You may need to kill and relaunch the main script twice after changing parameters</li>
</ul>
<h3>Method 2 output streams</h3>
<hr/>
<p> Stream Description </p><hr/>
<p> <b>wf0opd</b> Atmospheric WF OPD</p>
<p><b>wf0amp</b> Atmospheric WF amplitude</p>
<p><b>wf1opd</b> Wavefront OPD after correction [um] ( = wf0opd - 2 x dm05dispmap )</p>
<p><b>dm05disp</b> DM actuators positions</p>
<p><b>dm05dispmap</b> DM OPD map</p>
<p><b>WFSinst</b> Instantaneous WFS intensity</p>
<p><b>pWFSint</b> WFS intensity frame, time averaged to WFS frame rate and sampled to WFS camera pixels</p>
<p><b>aosim_foc0_amp</b> First focal plane (before coronagraph), amplitude</p>
<p><b>aosim_foc0_pha</b> First focal plane (before coronagraph), phase</p>
<p><b>aosim_foc1_amp</b> First focal plane (after coronagraph), amplitude</p>
<p><b>aosim_foc1_pha</b> First focal plane (after coronagraph), phase</p>
<p><b>aosim_foc2_amp</b> Post-coronagraphic focal plane, amplitude</p>
<p><b>aosim_foc2_pha</b> Post-coronagraphic focal plane, phase </p><hr/>
<h3>Processes and scripts details</h3>
<h4>Process <code>aosimmkWF</code></h4>
<p><code>aosimmkWF</code> reads precomputed wavefronts and formats them for the simulation parameters (pixel scale, temporal sampling).</p>
<p>Parameters for <code>aosimmkWF</code> are stored in configuration file:</p>
<p>File <code>aosimmkWF.conf.default</code> :</p>
<div class="fragment"><div class="line">!INCLUDE &quot;../scripts/aohardsim/aosimmkWF.conf.default&quot;</div></div><!-- fragment --><h4>Process <code>aosimDMrun</code></h4>
<p>File <code>aosimDMrun.conf.default</code> :</p>
<div class="fragment"><div class="line">!INCLUDE &quot;../scripts/aohardsim/aosimDMrun.conf.default&quot;</div></div><!-- fragment --><h4>Process <code>aosimPyrWFS</code></h4>
<p>File <code>aosimPyrWFS.conf.default</code> :</p>
<div class="fragment"><div class="line">!INCLUDE &quot;../scripts/aohardsim/aosimPyrWFS.conf.default&quot;</div></div><!-- fragment --><h3>AO loop control</h3>
<p>The <code>aolconf</code> script is used to configure and launch the AO control loop. It can be configured with input/output from real hardware or a simulation of real hardware.</p>
<h4>Shared memory streams</h4>
<hr/>
<p> Script Description </p><hr/>
<p> <b>wf0opd</b> Wavefront OPD prior to wavefront correction [um]</p>
<p><b>wf1opd</b> Wavefront OPD after correction [um] ( = wf0opd - 2 x dm05dispmap )</p>
<p><b>dm05disp</b> DM actuators positions</p>
<p><b>dm05dispmap</b> DM OPD map</p>
<p><b>WFSinst</b> Instantaneous WFS intensity</p>
<p><b>pWFSint</b> WFS intensity frame, time averaged to WFS frame rate and sampled to WFS camera pixels </p><hr/>
<h4>Hardware simulation architecture</h4>
<div class="image">
<img src="./figures/aosimlink.jpg" alt="data flow" title="aosim data flow"/>
</div>
<p>Close-loop simulation requires the following scripts to be launched to simulate the hardware, in the following order :</p>
<ul>
<li><code>aosimDMstart</code>: This script creates DM channels (uses dm index 5 for simulation). Shared memory arrays <code>dm05disp00</code> to <code>dm05disp11</code> are created, along with the total displacement <code>dm05disp</code>. Also creates the <code>wf1opd</code> shared memory stream which is needed by <code>aosimDMrun</code> and will be updated by runWF. <code>wf1opd</code> is the master clock for the whole simulation, as it triggers DM shape computation and WFS image computation.</li>
<li><code>aosimDMrun</code>: Simulates physical deformable mirror (DM)</li>
<li><code>aosimmkWF</code>: Creates atmospheric wavefronts</li>
<li><code>aosimWFS</code>: Simulates WFS</li>
</ul>
<p>Some key script variables need to coordinated between scripts. The following WF array size should match :</p>
<ul>
<li><code>WFsize</code> in script <code>aosimDMstart</code></li>
<li><code>ARRAYSIZE</code> in <code>aosimmkWF.conf</code></li>
<li><code>ARRAYSIZE</code> in <code>aosimDMrun.conf</code></li>
</ul>
<p>The main hardware loop is between <code>aosimmkWF</code> and <code>aosimWFS</code>: computation of a wavefront by <code>aosimmkWF</code> is <em>triggered</em> by completion of a WFS instantaneous image computation by <code>aosimWFS</code>. The configuration files are configured for this link.</p>
<h4>DM temporal response</h4>
<p>The DM temporal response is assumed to be such that the distance between the current position $p$ and desired displacement $c$ values is multiplided by coefficient $a&lt;1$ at each time step $dt$. The corresponding step response is :</p>
<p>$c - p((k+1) dt) = (c - p(k dt)) a$</p>
<p>$c - p(k dt) = (c-p0) a^k$</p>
<p>$p(k dt) = 1-a^k$</p>
<p>The corresponding time constant is</p>
<p>$a^{{t0}{dt}} = 0.5$</p>
<p>${t0}{dt} ln(a) = ln(0.5)$</p>
<p>$ln(a) = ln(0.5) dt/t0$</p>
<p>$a = 0.5^{{dt}{t0}}$</p>
<h3>Processes and scripts: system ouput</h3>
<p>The output (corrected) wavefront is processed to compute ouput focal plane images, and optionally LOWFS image.</p>
<h4>Process <code>aosimcoroLOWFS</code></h4>
<p>Computes coronagraphic image output and LOWFS image</p>
<p>File <code>aosimcoroLOWFS.conf.default</code>:</p>
<div class="fragment"><div class="line">!INCLUDE &quot;../scripts/aohardsim/aosimcoroLOWFS.conf.default&quot;</div></div><!-- fragment --><h4>Ouput simulation architecture</h4>
<div class="image">
<img src="./figures/aosimlink_coroLOWFS.jpg" alt="coroLOWFS data flow" title="coroLOWFS data flow"/>
</div>
<h2>METHOD 3: Linear Hardware Simulation</h2>
<h3>Overview</h3>
<p>The Linear Hardware Simulation (LHS) uses a linear response matrix to compute the WFS image from the DM state. It is significantly faster than the Physical Hardware Simulation (PHS) but does not capture non-linear effects.</p>
<h3>Setup</h3>
<ul>
<li>Create directory LHScalib:</li>
</ul>
<div class="fragment"><div class="line">mkdir LHScalib</div></div><!-- fragment --><ul>
<li>Download response matrix and reference, place them in directory <code>LHScalib</code>.</li>
<li>Start GUI, loop 5, name simLHS</li>
</ul>
<div class="fragment"><div class="line">./aolconf -L 5 -N simLHS</div></div><!-- fragment --><ul>
<li>Start DM: index 04, 50 x 50; Auto-configure: main DM (no link); STOP -&gt; (re-)START DM comb process</li>
<li>Go to <code>TEST MODE</code> GUI</li>
<li>Enter linear simulation zonal response matrix and linear simulation WFS reference (<code>zrespMlinsim</code> and <code>wfsref0linsim</code> selections at top of screen).</li>
<li><b>Start linear simulator</b> (<code>lsimon</code> selection). The simulator reacts to changes in aol5_dmdisp (= dm04disp) </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="page_cacao_topmenu.html">Subpages</a></li><li class="navelem"><a class="el" href="page_cacao_top_guide.html">Configuring and Running cacao</a></li>
    <li class="footer">Generated on Sat Feb 16 2019 22:30:48 for cacao by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
