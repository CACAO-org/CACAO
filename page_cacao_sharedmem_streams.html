<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cacao: APPENDIX A: SHARED MEMORY STREAMS</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="cacao-logo-small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">cacao
   &#160;<span id="projectnumber">Release 0.1.03-dev</span>
   </div>
   <div id="projectbrief">Compute And Control For Adaptive Optics</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_cacao_sharedmem_streams.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">APPENDIX A: SHARED MEMORY STREAMS </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Linking to existing stream</h2>
<p>Creates a sym link from an existing stream to a new stream. This is frequently used to connect to hardware (for example pointing aol8_wfsim to the WFS camera stream).</p>
<p>Within AOCCE, setting (new) stream aol::_&lt;deststream&gt; to point to &lt;srcstream&gt; involves:</p>
<ul>
<li>writing "\&lt;srcstream\&gt;" to file conf/streamlink_&lt;deststream&gt;.name.txt</li>
<li>removing any existing aol::_&lt;deststream&gt; stream</li>
<li>establishing sym link from &lt;srcstream&gt; to aol::_&lt;deststream&gt;</li>
</ul>
<p>The corresponding commands, to point aol8_wfsim to imcam, would be: </p><pre class="fragment">echo "imcam" &gt; conf/streamlink_wfsim.name.txt
rm /tmp/aol8_wfsim.im.shm
ln -s /tmp/imcam.im.shm /tmp/aol8_wfsim.im.shm
</pre><p>This is implemented in script : </p><pre class="fragment">./aolfuncs/aolfunc_StreamLink
</pre><h2>Loading images from FITS to shared memory stream</h2>
<h3>Overview</h3>
<p>Loading FITS file into a new or existing stream.</p>
<p>The recommended command to load a FITS image to shared memory in AOCCE is for example: </p><pre class="fragment">echo "./wfsref0/wfsref0_today.fits" &gt; ./conf/shmim_wfsref0.name.txt
Fits2shm -c -p aol${LOOPNUMBER}_ wfsref0
</pre><p>This command will skip loading if the stream does not need to be updated from the last load command. Add the -f option to force loading.</p>
<p>Options used: </p><pre class="fragment"> -c           read FITS file name from ./conf/shmim_&lt;streamname&gt;.name.txt directory
 -p &lt;pref&gt;    stream prefix
</pre><h3>Detailed description</h3>
<p>File name can be :</p>
<ul>
<li>option A: read from ./conf/shmim_&lt;stream&gt;.name.txt</li>
<li>option B: specfied and written to ./conf/shmim_&lt;stream&gt;.name.txt</li>
</ul>
<p>Command for option A: </p><pre class="fragment">Fits2shm &lt;FITS file&gt; &lt;stream&gt;
</pre><p>Command for option B: </p><pre class="fragment">Fits2shm -c &lt;stream&gt;
</pre><p>A prefix is usually added to the shared memory file with the -p option: </p><pre class="fragment">Fits2shm -c -p aol8_ &lt;stream&gt;
</pre><p>The -r removes/clears any previous instance of the stream and associated files: it is a stronger option than -f.</p>
<p>Fits2shm is located in the src/scripts/ directory of the AOCCE source code.</p>
<p>For both options, FITS files and shared memory files are inspected to assess need to load the image. If repetitive load requests are issued on the same file and shared memory, the script may decide that no action is required as the shared memory is already up-to-date.</p>
<p>Local directory ./loadedSM/ is used to keep track of streams loaded from FITS files.</p>
<p>Important files:</p>
<hr/>
<p> File Description </p><hr/>
<p> ./loadedSM/&lt;stream&gt;.FITSinfo FITS file name, size, time of last modification</p>
<p>./loadedSM/&lt;stream&gt;.FITSinfo.old previous version of above file - to be used for comparison</p>
<p>./loadedSM/&lt;stream&gt;.FITSsame File exists if the two FITS files are identical</p>
<p>./loadedSM/&lt;stream&gt;.FITSchanged File exists if the two FITS files are different</p>
<p>./loadedSM/&lt;stream&gt;.SMinfo stream file name, size, time of last modfification</p>
<p>./loadedSM/&lt;stream&gt;.SMinfo.old previous version of above file - to be used for comparison</p>
<p>./loadedSM/&lt;stream&gt;.SMsame File exists if the two SM files are identical</p>
<p>./loadedSM/&lt;stream&gt;.SMchanged File exists if the two SM files are different</p>
<p>./loadedSM/&lt;stream&gt;.imsize Image size - updated upon SM load</p>
<p>./loadedSM/&lt;stream&gt;.new File exists if last load request updated or created stream</p>
<p>./loadedSM/&lt;stream&gt;.kept File exists if last load request kept stream unchanged</p>
<p>./loadedSM/&lt;stream&gt;.missing File exists if last load request created new stream (stream was missing)</p>
<p>./conf/shmim_&lt;stream&gt;.name.txt FITS file name for stream</p>
<p>./conf/shmim_&lt;stream&gt;.imsize.txt Stream size</p>
<p>./conf/shmim_&lt;stream&gt;.fits (symbolic link to) FITS file</p>
<p>./tmp/&lt;prefix&gt;&lt;stream&gt;.im.shm File-mapped shared memory </p><hr/>
<p>The logic behind Fits2shm is as follows:</p>
<ul>
<li>Assume LOAD=0 (do not load FITS file in memory)</li>
<li>Check if FITS file has changed. If yes, set LOAD=1</li>
<li>Check if SM file has changed. If yes, set LOAD=1</li>
<li>Check if SM file exists, if not:<ul>
<li>set LOAD=1</li>
<li>create &lt;stream&gt;.missing file (otherwise, rm &lt;stream&gt;.missing file)</li>
</ul>
</li>
<li>Check if FORCE option, if yes, set LOAD=1</li>
<li>If LOAD=1:<ul>
<li>load file to shared memory</li>
</ul>
</li>
</ul>
<p>When loading :</p>
<ul>
<li>OPTION A only: update ./conf/shmim_&lt;stream&gt;_name.txt to the FITS file name</li>
<li>update ./loadedSM/&lt;stream&gt;.FITSinfo file</li>
<li>update ./loadedSM/&lt;stream&gt;.SMinfo file</li>
<li>create ./loadedSM/&lt;stream&gt;.kept OR ./loadedSM/&lt;stream&gt;.new file, remove the other one</li>
<li>create ./loadedSM/&lt;stream&gt;.missing file if the SM file did not exist, otherwise remove ./loadedSM/&lt;stream&gt;.missing</li>
<li>copy ./loadedSM/&lt;stream&gt;.imsize file to ./conf/shmim_&lt;stream&gt;.imsize.txt</li>
<li>load FITS file to ./tmp/&lt;prefix&gt;&lt;stream&gt;.im.shm</li>
<li>create sym link ./conf/shmim_&lt;stream&gt;.fits pointing to FITS file </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="page_cacao_topmenu.html">Subpages</a></li><li class="navelem"><a class="el" href="page_cacao_top_guide.html">Configuring and Running cacao</a></li>
    <li class="footer">Generated on Thu Apr 2 2020 16:50:24 for cacao by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
